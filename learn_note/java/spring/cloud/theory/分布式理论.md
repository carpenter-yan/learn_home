[张大胖和CAP定理（分布式系统、可用性、一致性、分区容错性）](http://blog.itpub.net/69947338/viewspace-2656369/)
[用三国杀讲分布式算法，舒适了吧？](https://mp.weixin.qq.com/s?__biz=MzAwMjI0ODk0NA==&mid=2451949807&idx=1&sn=d8fb211bc87275e004a8001e095ef402&chksm=8d1c3170ba6bb866ca19548e3922d64d194a0c798622aa954e0236b85cb0869c88ff40f3deed&scene=178&cur_album_id=1510122164576911361#rd)  
##学习路线
学习分布式协议和算法的路线可以是先学习四大基础理论，再学习分布式协议和算法

###（一）四大基础理论
- 拜占庭将军问题
- CAP理论
- ACID理论
- BASE理论

###八大分布式协议和算法
- Paxos算法
- Raft算法
- ZAB协议
- Gossip协议算法
- 一致性Hash算法
- QuorumNWR算法
- FBFT算法
- POW算法

###拜占庭将军问题
如果叛将人数为 m，将军数 n >= 3m + 1，那么就可以解决拜占庭将军问题。
前提条件：叛将数m已知，需要进行m + 1轮的作战协商

通过三国杀角色来讲解分布式中共识场景。那他们和分布式系统的映射关系是怎么样的呢？
- 将军对应计算机节点。
- 忠臣的将军对应正常运行的计算机节点。
- 叛变的将军对应出现故障并会发送误导信息的计算机节点。
- 信使被杀对应通讯故障、信息丢失。
- 信使被间谍替换对应为通讯被恶意攻击、伪造信息或劫持通讯。

可不要小瞧拜占庭问题，它可是分布式场景最复杂的的故障场景。
比如在数字货币的区块链技术中就有用到这些知识点。
而且必须使用拜占庭容错算法（也就是 Byzantine Fault Tolerance，BFT）。
拜占庭容错算法还有 FBFT 算法，PoW 算法，当然不会在这篇中去讲这些算法，
有了拜占庭容错算法，肯定有非拜占庭容错算法，顾名思义，就是没有发送误导信息的节点。
CFT算法就是解决分布式系统中存在故障，但不存在恶意节点的场景下的共识问题。
简单来说就是可能因系统故障造成丢失消息或消息重复，但不存在错误消息、伪造消息。
对应的算法有Paxos算法、Raft算法、ZAB协议。
上面提到了5种算法，居然都是跟拜占庭问题有关，你说今天讲的拜占庭问题重要不重要？
这么多算法该如何选择？
节点可信，选非拜占庭容错算法。否则就用拜占庭容错算法，如区块链中用到的PoW算法。

[用太极拳讲分布式理论，真舒服！](https://mp.weixin.qq.com/s?__biz=MzAwMjI0ODk0NA==&mid=2451950422&idx=1&sn=7f86457acedbd0853cbcb7dc4377dd54&chksm=8d1c32c9ba6bbbdfd3d8c698addfb13a02589409bdf6a03a777e9afc95249018293d9a9e0a3f&scene=21#wechat_redirect)  
###（二）三大理论
####CAP
CAP 理论是对分布式系统的特性做了一个高度的抽象，变成了三大指标：
- 一致性（Consistency）
- 可用性（Availability）
- 分区容错性（Partition Tolerance） 
  分布式中的一致性，我们可以理解为客户端的每次读操作，不管访问的是哪个几点，要么读到的都是同一份最新写入的数据，
要么读取失败。一致性强调的是数据正确，每次读取节点中的数据都是最新写入的数据。
  可用性牺牲数据准确性，每个节点使用本地数据来响应客户端的请求。另外当节点不可用时，可以使用快速失败策略，
至少不能让服务长时间不能响应。可用性强调的是服务可用，不保证数据正确。
  分区容错性的含义就是节点间出现任意数量的消息丢失或高延迟的时候，系统仍然在继续工作。分布式系统告诉客户端，
我的内部不论出现什么样的数据同步问题，我会一直运行。强调的是集群堆分区故障的容错能力。

对于分布式系统，CAP 三个指标只能选择其中两个。
CA：保证一致性和可用性。当分布式系统正常运行时（大部分时候所处的状态），这个时候不需要P，那么C和A能够同时保证。
只有在发生分区故障时，才需要P，这个时候就只能在C和A之间做出选择。典型应用：单机版部署的MySQL。
CP：保证数据的一致性和分区容错性，比如配置信息，必须保证每个节点存的都是最新的，正确的数据。
比如Raft的强一致性系统，在分区出错时会导致无法执行读操作和写操作。典型应用：Etcd、Consul、Hbase。
AP：保证分布式系统的可用性和分区容错性。用户访问系统，都能得到相应数据，不会出现响应错误，但是可能会读到旧的数据。
典型应用：Cassandra 和 DynamoDB。

####ACID
ACID是研究SQL数据库的理论，原子性（Atomicity）、一致性（Consistency）、隔离性（Isolation）、持久性（Durability）。
分布式系统下该如何解决事务问题呢？比如二阶段提交协议和TCC协议等

####BASE
BASE的核心：基本可用BA（Basically Available）、软状态 S（Soft state）、最终一致性 E（Eventually consistent）
怎么理解基本可用？重点是在这个基本，这个理论并没有告诉我们怎么定义基本，这是一个模糊的概念。其实就是要柔到什么程度。
在分布式系统中，我们可以把基本可用理解为保证核心功能可用，允许损失部分功能的可用性。基本可用可以用四种方案来实现。
- 流量削峰：
  比如多个秒杀场次，某东的 8 点秒杀场，12 点的秒杀场。
- 延迟响应：
  比如双 11 期间某商城创建的订单，会提示客户订单正在创建中，可能需要等个十几秒。
- 体验降级：
  比如某次比赛活动，有大量用户进活动页查看图片，这个时候，大量图片因为网络超时而无法显示，这个时候就可以考虑替换原有图片，返回清晰度没有那么高或图片比较小的图片。
- 过载保护：
  比如我们常用的消息队列占满了，可以考虑丢弃后来的请求，或清除队列中的一些请求，保护系统不过载，但这都需要结合自身的业务场景来设计。

太极拳分为阴和阳两方面，就如CAP中的C和A。
- CAP 理论是分布式中基础理论，有三个重要指标：一致性、可用性、分区容错性。
- ACID 是传统数据库的设计理念，追求强一致性。四个指标：原子性、一致性、隔离性、持久性。是 CAP 中 CP 的延伸。
- BASE 理论是 CAP 中一致性和可用性权衡的结果。是 CAP 中的 AP 的延伸。
  注重可用性和性能优先，根据业务的场景特点，实现弹性的基本可用，然后实现数据的最终一致性。
- BASE 理论在很大程度上，解决了事务性系统在性能、容错、可用性等方面的通病。
- BASE 理论在 NoSQL 中应用广泛，是 NoSQL 系统设计的事实上的理论支撑。

[诸葛亮 VS 庞统，拿下分布式 Paxos](https://mp.weixin.qq.com/s/3V5dJ0mwmeyfWWRU4oigbA)  
###（三)PAXOS
Paxos中有三种角色：提议者、接受者、学习者
- 提议者（Proposer）
  提议一个值，用于投票表决。接入和协调，收到客户端的请求后，可以发起二阶段提交，进行共识协商。 
- 接受者（Acceptor）
  对每个提议的值进行投票，并存储接受的值。投票协商和存储数据，对提议的值进行投票，并接受达成共识的值，存储保存。
- 学习者（Learner）
  被告知投票的结果，接受达成共识的值，存储数据，不参与投票的过程，即不参与共识协商。

<font color="yellow" size=5>详细过程见原文</font>

Basic Paxos也是通过二阶段提交协议达成共识。准备阶段、接受阶段。
Basic Paxos 不仅仅实现了共识，还实现了容错。有少于一半的节点出现故障时，集群也能正常工作。
提案编号代表优先级，保证了三个承诺：
- 如果准备请求的提案编号，小于等于接受者已经响应的准备请求的提案编号，那么接受者将承诺不响应这个准备请求。
- 如果接受请求中的提案的提案编号，小于接受者已经响应的准备请求的提案，那么接受者将承诺不通过这个提案。
- 如果接受者之前有通过提案，那么接受者将承诺，会在准备请求的响应中，包含已经通过的最大编号的提案信息。

[用动图讲解分布式 Raft](https://mp.weixin.qq.com/s/US12ux7osqH_L0CtQyw-9A)  
###(四)RAFT
- 跟随者（Follower）：
  普通群众，默默接收和来自领导者的消息，当领导者心跳信息超时的时候，就主动站出来，推荐自己当候选人。
- 候选人（Candidate）：
  候选人将向其他节点请求投票 RPC 消息，通知其他节点来投票，如果赢得了大多数投票选票，就晋升当领导者。
- 领导者（Leader）：
  霸道总裁，一切以我为准。处理写请求、管理日志复制和不断地发送心跳信息，通知其他节点“我是领导者，我还活着，你们不要”发起新的选举，不用找新领导来替代我。

<font color="yellow" size=5>详细过程见原文</font>

[韩信大招：一致性哈希](https://mp.weixin.qq.com/s?__biz=MzAwMjI0ODk0NA==&mid=2451951106&idx=1&sn=d77d2486a6945c1138143c491a3d3d46&chksm=8d1c379dba6bbe8b2df47d237cbd8fbad94e4ab4091876661103b768b1653fc100250af46e6f&cur_album_id=1531609419468308481&scene=189#rd)
###一致性哈希
- 哈希算法会带来增加或删除节点时，数据迁移量太大的问题。
- 一致性哈希算法降低了数据迁移量。
- 节点较少，哈希环上每个节点实际占据的区间大小不一，最终导致业务对节点的访问冷热不均。
- 引入虚拟节点映射解决了分布不均问题。
- 节点越多时，使用哈希算法时，需要迁移的数据就越多，而使用一致性哈希算法，迁移的数据就越少。
- 一致性哈希算法本质上是一种路由寻址算法，适合简单的路由寻址场景。
- 一致性哈希算法常用在负载均衡的架构设计中。

[病毒入侵：全靠分布式](https://mp.weixin.qq.com/s/2xosUVcEeApeEgcQNYcOaw)  
###Gossip协议

[太上老君的炼丹炉之分布式 Quorum NWR](https://mp.weixin.qq.com/s?__biz=MzAwMjI0ODk0NA==&mid=2451951401&idx=1&sn=05b864d9520ce262fa6e5f66b2c4ff1a&chksm=8d1c36b6ba6bbfa0ca2e6c9351f24f51eac30d77c8215860cebd77e72639380e96388734f44e&scene=21#wechat_redirect)  
###NWR算法

[紫霞仙子：顶得住区块链的十二连问吗？](https://mp.weixin.qq.com/s?__biz=MzAwMjI0ODk0NA==&mid=2451951605&idx=1&sn=ac1ee88e4d4c1387ed441a957e155c78&chksm=8d1c366aba6bbf7c7ccd3a4ff048d950195004a45633befe9594efd3aafc8c93936551e3efcd&scene=21#wechat_redirect)  
###POW算法
